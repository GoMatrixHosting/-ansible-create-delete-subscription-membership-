
# change authorized_keys on the client server
# reset 'AWX SSH Key credential' in that subscription

# Example output:
# gomatrixhostingfuckyeah.xyz - 00 - Rotate SSH Key,billy.bob
# gomatrixhostingforever.xyz - 00 - Rotate SSH Key,64
# gomatrixhostingisawesome.xyz - 00 - Rotate SSH Key,63

- name: Collect necessary variables from input
  set_fact:
    id_array: "{{ item.split(',') }}"

- name: Execute every job template sequentially
  awx.awx.tower_job_launch:
    job_template: "{{ id_array.0 }}"
    tower_host: "https://{{ tower_host }}"
    tower_oauthtoken: "{{ tower_token.stdout }}"
    validate_certs: yes 
  register: job

- name: Wait for job max 300s
  awx.awx.tower_job_wait:
    job_id: "{{ job.id }}"
    timeout: 300
    tower_host: "https://{{ tower_host }}"
    tower_oauthtoken: "{{ tower_token.stdout }}"
    validate_certs: yes
  ignore_errors: yes

# YOU CAN'T DELEGATE TO A HOST THAT ISN'T DEFINED IN THE INVENTORY :) needs a deploy stage job imo

# need member_id
# need client_private_ssh_key_password ???

- name: Re-create 'AWX SSH Key' credential in users organisation
  delegate_to: 127.0.0.1
  awx.awx.tower_credential:
    name: "{{ id_array.1 }} - AWX SSH Key"
    description: "The SSH key for Provision/Deploy"
    organization: "{{ id_array.1 }}"
    credential_type: Machine
    inputs:
      ssh_key_data: "{{ lookup('file', '/var/lib/awx/projects/hosting/client_private.key') }}"
      ssh_key_unlock: "{{ client_private_ssh_key_password }}"
    tower_host: "https://{{ tower_host }}"
    tower_oauthtoken: "{{ tower_token.stdout }}"
    validate_certs: yes
