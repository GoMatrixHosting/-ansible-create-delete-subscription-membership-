
- name: Set swap size for Wireguard Server
  delegate_to: 127.0.0.1
  set_fact:
    swap_size: "1G"

- name: Test if SSH is possible with ipv4
  delegate_to: "{{ server_ip }}"
  command: echo success
  register: echo_output
  
- debug:
    msg: "{{ echo_output.stdout }}"

- name: Disable password authentication
  delegate_to: "{{ server_ip }}"
  lineinfile:
    path: /etc/ssh/sshd_config
    line: 'PasswordAuthentication no'

- name: Restart SSH
  delegate_to: "{{ server_ip }}"
  service:
    name: ssh
    state: restarted
    
- name: Include hosting vars of digital_ocean.yml
  include_vars:
    file: /var/lib/awx/projects/hosting/hosting_vars.yml
  no_log: True

- name: Collect AWX admin token the hard way!
  delegate_to: 127.0.0.1
  shell: |
      curl -sku {{ tower_username }}:{{ tower_password }} -H "Content-Type: application/json" -X POST -d '{"description":"Tower CLI", "application":null, "scope":"write"}' https://{{ tower_host }}/api/v2/users/1/personal_tokens/ | jq '.token' | sed -r 's/\"//g'
  register: tower_token
  no_log: True

- name: Add wireguard host to organisations inventory
  delegate_to: 127.0.0.1
  awx.awx.tower_host:
    name: "wireguard.{{ matrix_domain }}"
    description: "{{ matrix_domain }} Wireguard Proxy"
    inventory: "{{ member_id }}"
    state: present
    tower_host: "https://{{ tower_host }}"
    tower_oauthtoken: "{{ tower_token.stdout }}"
    validate_certs: yes
