
- name: Install necessary packages
  delegate_to: "{{ server_ip_final }}"
  apt:
    pkg:
    - ufw

- name: Allow all access to TCP port 22 for SSH
  delegate_to: "{{ server_ip_final }}"
  ufw:
    rule: allow
    port: '22'
    proto: tcp

- name: Allow all access to TCP port 80 for HTTP
  delegate_to: "{{ server_ip_final }}"
  ufw:
    rule: allow
    port: '80'
    proto: tcp

- name: Allow all access to TCP port 443 for HTTPS
  delegate_to: "{{ server_ip_final }}"
  ufw:
    rule: allow
    port: '443'
    proto: tcp

- name: Allow all access to TCP/UDP port 5349 for TURN
  delegate_to: "{{ server_ip_final }}"
  ufw:
    rule: allow
    port: '5349'
    proto: any

- name: Allow all access to TCP port 8448 for Matrix Federation
  delegate_to: "{{ server_ip_final }}"
  ufw:
    rule: allow
    port: '8448'
    proto: tcp

- name: Allow all access to UDP port 49152-49172 for STUN
  delegate_to: "{{ server_ip_final }}"
  ufw:
    rule: allow
    port: 49152:49172
    proto: tcp

- name: Allow all access to UDP port 10000 for Jitsi
  delegate_to: "{{ server_ip_final }}"
  ufw:
    rule: allow
    port: '10000'
    proto: udp
    
- name: Allow all access to TCP port 25 for SMTP
  delegate_to: "{{ server_ip_final }}"
  ufw:
    rule: allow
    port: '25'
    proto: tcp

- name: Allow all access to TCP port 587 for SMTP
  delegate_to: "{{ server_ip_final }}"
  ufw:
    rule: allow
    port: '587'
    proto: tcp

- name: Allow all access to TCP port 9100 for Synapse metrics
  delegate_to: "{{ server_ip_final }}"
  ufw:
    rule: allow
    port: '9000'
    proto: tcp
    
- name: Allow all access to TCP port 9100 for Node-Exporter metrics
  delegate_to: "{{ server_ip_final }}"
  ufw:
    rule: allow
    port: '9100'
    proto: tcp
    
- name: Default allow outgoing traffic with UFW
  delegate_to: "{{ server_ip_final }}"
  ufw:
    policy: allow
    direction: outgoing

- name: Default deny incoming traffic with UFW
  delegate_to: "{{ server_ip_final }}"
  ufw:
    policy: deny
    direction: incoming

- name: Enable UFW
  delegate_to: "{{ server_ip_final }}"
  ufw:
    state: enabled

